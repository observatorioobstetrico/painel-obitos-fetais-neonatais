---
title: "Óbitos Fetais e Neonatais" 
output: 
  flexdashboard::flex_dashboard:
    logo: www/logo-oobr.png
    favicon: www/logo-oobr-browser.png
    theme:
      version: 4
      navbar-bg: "#0A1E3C"
    orientation: rows
    source_code: embed
    navbar:
        - { icon: "fa-github", href: "https://github.com/observatorioobstetrico/painel-obitos-fetais-neonatais", target: _blank, align: right}
        - { icon: "fa-twitter", href: "https://twitter.com/observatorioobr", target: _blank, align: right}
        - { icon: "fa-instagram", href: "https://www.instagram.com/observatorioobr", target: _blank, align: right}
        - { icon: "fa-youtube", href: "https://www.youtube.com/channel/UCp4k0g_6yP-S8G2DU6_lSeQ", target: _blank, align: right }
        - { icon: "fa-envelope", href: "mailto:comunicacao@observatorioobstetricobr.org", target: _blank, align: right }
runtime: shiny   
---

<style>
.navbar.navbar-inverse {
  background-color: #0A1E3C !important;
  border-color: #0A1E3C !important;
}
.navbar-brand {
    color: #ffffff !important;
    font-size: 1.3rem;
    vertical-align: middle;
}
body {
    font-size: 1em;
    background: white;
    padding: 83px 15px 8px;
}
.section.sidebar {
  top: 50px;
  background-color: #eaf2ff;
  color: #000000
}
.negrito {
  font-weight: 700;
}
.chart-title {
    border-bottom: 1px solid #dee2e6;
    font-size: 1.1em;
    font-weight: 600;
    padding: 7px 10px 4px;
}
</style>


```{r}
knitr::opts_chunk$set(message = FALSE)
```


```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(shiny)
library(reactable)
library(reactablefmtr)
library(openxlsx)
library(glue)


# Carregando os arquivos necessários
tabela_aux_municipios <- read_delim("R/databases/tabela_auxiliar_municipios.csv", 
                                              delim = ",", escape_double = FALSE, trim_ws = TRUE) 

dados_obitos_fetais <- read.csv(gzfile("dados_oobr_obitos_fetais_2012_2024.csv.gz")) 

dados_obitos_neonatais <- read.csv(gzfile("dados_oobr_obitos_neonatais_2012_2024.csv.gz")) 

dados_obitos_fetais_neonatais <- full_join(dados_obitos_fetais, dados_obitos_neonatais) |>
  arrange(codigo) |>
  mutate(
    faixa_de_peso = factor(
      faixa_de_peso,
      levels = c("< 1500 g", "1500 a 1999 g","2000 a 2499 g", "≥ 2500 g", "Sem informação")
    ),
    racacor = factor(
      racacor,
      levels = c("Branca", "Preta", "Amarela", "Parda", "Indígena", "Ignorado")
    )
  )


estadosChoices <- sort(unique(tabela_aux_municipios$uf))

# Definindo as configurações globais das tabelas
options(reactable.theme = reactableTheme(
  borderColor = "#dfe2e5",
  stripedColor = "#e5efff",
  highlightColor = "#CDDEFC",
  cellPadding = "8px 12px",
  searchInputStyle = list(width = "100%")
))

# Obtendo o dia, mês e ano por extenso
df_meses <- data.frame(
  num_mes = 1:12,
  nome_mes = c("janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho",
               "agosto", "setembro", "outubro", "novembro", "dezembro")
)

data <- Sys.Date()
data_por_extenso <- glue(
  "{substr(data, 9, 10)} de {df_meses$nome_mes[which(df_meses$num_mes == as.numeric(substr(data, start = 6, stop = 7)))]} de {substr(data, 1, 4)}"
)
```

Sobre
=============================================

<h3><span style = "font-weight: bold;">O OOBr Óbitos Fetais e Neonatais</span></h3>

É um painel de visualização dinâmico com análises acerca da mortalidade de fetos e neonatos no Brasil, sob a perspectiva de algumas variáveis da base de dados do Sistema de Informações sobre Mortalidade (SIM). As informações consideradas são referentes aos registros de óbitos de fetos e neonatos dos anos de 2012 a 2024 **(sendo os dados de 2023 e 2024 preliminares)**.

<h3><span style = "font-weight: bold;">O Observatório Obstétrico Brasileiro (OOBr)</span></h3>

Tem como objetivo disponibilizar plataformas interativas de monitoramento e análises de dados públicos cientificamente embasadas e disseminar informações de qualidade e relevantes acerca da área da saúde materno-infantil.

Conta com **pesquisadores** da <a href = https://www.ufes.br target = _blank> Universidade Federal do Espírito Santo (UFES) </a> e da <a href = https://www5.usp.br target = _blank> Universidade de São Paulo (USP)</a>. Para maiores informações, veja o <a href = https://observatorioobstetricobr.org/ target = _blank> site do OOBr</a>.

<h3><span style = "font-weight: bold;">Os dados</span></h3>

São providos do DATASUS do Ministério da Saúde e formam um grande banco anual composto por todos os registros das declarações de óbitos (o SIM) que está disponível a partir do ano de 1996. Atualmente, os dados do SIM estão disponíveis até 2024 **(sendo estes e os de 2023 preliminares)**. Os dados deste painel são atualizados na última sexta feira de cada mês, tendo a última atualização ocorrido em `r data_por_extenso`.

<h3><span style = "font-weight: bold;">Contato</span></h3>

Para comentários, sugestões e colaborações científicas, por favor, envie uma mensagem para <a href="mailto:comunicacao@observatorioobstetricobr.org"> comunicacao@observatorioobstetricobr.org</a>. E para acompanhar o trabalho do OOBr de perto, siga-o nas redes acessando os ícones do canto superior direito.  

<h3><span style = "font-weight: bold;">Realização</span></h3>

<center>
```{r, out.width="10%", fig.show='hold'}
knitr::include_graphics(c(
  "www/logos/realizacao/logo_oobr.png",
  "www/logos/realizacao/logo_ufes.png",
  "www/logos/realizacao/logo_medicina_usp.png", 
  "www/logos/realizacao/logo_daslab.png"
))
```
</center>

<h3><span style = "font-weight: bold;">Financiadores</span></h3>

<center>
```{r, teste, out.width="10%", fig.show='hold'}
knitr::include_graphics(c(
  "www/logos/financiadores/logo_bill_melinda.png",
  "www/logos/financiadores/logo_cnpq.png",
  "www/logos/financiadores/logo_ms1.png", 
  "www/logos/financiadores/logo_ms2.png", 
  "www/logos/financiadores/logo_ms3.png", 
  "www/logos/financiadores/logo_fapes.png",
  "www/logos/financiadores/logo_fapes2.png"
))
```
</center>


<h3><span style = "font-weight: bold;">Apoio</span></h3>

<center>
```{r, out.width="8%", fig.show='hold'}
knitr::include_graphics(c(
  "www/logos/apoio/logo_pcdas.png",
  "www/logos/apoio/logo_odd.png"
))
```
</center>



Óbitos por categoria da CID-10 {data-navmenu="Visualizações"}
=========================================================

Inputs {.sidebar data-width=350 style="width: 350px; visibility: visible; top: 75px;"}
------------------------------------- 
```{r input-obitosM}
hr();h5(span("Óbitos fetais e neonatais por categoria da CID-10", style = "font-weight: bold;")); hr()
p(em("Obs.: os dados de 2023 são preliminares."))
hr()

selectInput(
  inputId = "selectTipo",
  label = HTML("<span class = 'negrito'> Selecione o tipo de óbito: </span>"),
  choices = c("Fetais", "Neonatais precoces", "Neonatais tardios", "Neonatais", "Pós-neonatais")
)

hr()
span("Temporalidade e localidade", style = "font-weight: bold; font-size: 17px")
HTML("<span style='display: block; margin-bottom: 7px;'> </span>")

numericInput(
  inputId = "selectAno",
  label = HTML("<span class = 'negrito'> Selecione o ano de análise: </span>"),
  value = max(dados_obitos_fetais_neonatais$ano),
  min = min(dados_obitos_fetais_neonatais$ano),
  max = max(dados_obitos_fetais_neonatais$ano)
)

selectInput(
  inputId = "selectNivel",
  label = HTML("<span class = 'negrito'> Selecione o nível de análise: </span>"),
  choices = c("Nacional", "Estadual", "Municipal"),
  selected = "Nacional"
)

conditionalPanel(
  condition = "input.selectNivel == 'Nacional'",
  checkboxGroupInput(
    inputId = "selectRegiao",
    label = HTML("<span class = 'negrito'> Selecione as regiões de análise: </span>"),
    choices = c("Norte", "Nordeste", "Centro-Oeste", "Sudeste", "Sul"),
    selected = c("Norte", "Nordeste", "Centro-Oeste", "Sudeste", "Sul")
  )
)

conditionalPanel(
  condition = "input.selectNivel == 'Estadual'",
  selectInput(
    inputId = "selectEstado",
    label = HTML("<span class = 'negrito'> Selecione o estado: </span>"),
    choices = estadosChoices,
    multiple = FALSE
    )
)

conditionalPanel(
    condition = "input.selectNivel == 'Municipal'",
    selectizeInput(
      inputId = "selectEstadoMuni",
      label = HTML("<span class = 'negrito'> Selecione o estado ao qual pertence o município: </span>"),
      choices = estadosChoices,
      options = list(placeholder = "Selecione um estado")
    ),
    selectizeInput(
      inputId = "selectMunicipio",
      label = HTML("<span class = 'negrito'> Selecione o município: </span>"),
      choices = NULL,
      options = list(placeholder = "Selecione um município")
    )
)

observeEvent(input$selectEstadoMuni, {
  updateSelectizeInput(
    inputId = "selectMunicipio",
    choices = sort(dados_obitos_fetais_neonatais |> dplyr::filter(uf == unique(tabela_aux_municipios$sigla_uf[which(tabela_aux_municipios$uf == input$selectEstadoMuni)])) |> pull(municipio) |> unique())
  )
})

hr()
span("Características do feto ou neonato", style = "font-weight: bold; font-size: 17px")
HTML("<span style='display: block; margin-bottom: 7px;'> </span>")


checkboxGroupInput(
  inputId = "selectPeso",
  label = HTML("<span class = 'negrito'> Selecione as faixas de peso ao nascer: </span>"),
  choices = c("< 1500 g", "1500 a 1999 g", "2000 a 2499 g", "≥ 2500 g", "Sem informação"),
  selected = c("< 1500 g", "1500 a 1999 g", "2000 a 2499 g", "≥ 2500 g", "Sem informação")
)

checkboxGroupInput(
  inputId = "selectRaca",
  label = HTML("<span class = 'negrito'> Selecione a raça/cor do feto ou neonato: </span>"),
  choices = c("Branca", "Preta", "Amarela", "Parda", "Indígena", "Ignorado"),
  selected = c("Branca", "Preta", "Amarela", "Parda", "Indígena", "Ignorado")
)

hr()

selectInput(
  inputId = "selectDownload",
  label = HTML("<span class = 'negrito'> Deseja fazer o download dessa tabela? </span>"),
  choices = c("Não", "Sim"),
  selected = "Não"
)

conditionalPanel(
  condition = "input.selectDownload == 'Sim'",
  selectInput(
    inputId = "selectArquivo",
    label = HTML("<span class = 'negrito'> Selecione o tipo do arquivo: </span>"),
    choices = c("CSV", "XLSX"),
    selected = "CSV"
  ),
  conditionalPanel(
    condition = "input.selectArquivo == 'CSV'",
    downloadHandler(
      filename = reactive({
        case_when(
          input$selectNivel == "Nacional" ~ paste0(glue::glue("obitos_{nome_tabela()}_"), janitor::make_clean_names(input$selectNivel), input$selectAno, ".csv"),
          input$selectNivel == "Estadual" ~ paste0(glue::glue("obitos_{nome_tabela()}_"), janitor::make_clean_names(input$selectEstado), input$selectAno, ".csv"),
          input$selectNivel == "Municipal" ~
            paste0(glue::glue("obitos_{nome_tabela()}_"), janitor::make_clean_names(gsub(" ", "_", gsub(" - ", " ", input$selectMunicipio))), input$selectAno, ".csv")
        )
        }),
      content = function(file) {
        write.table(dados_download(), file, sep = ";", row.names = FALSE, fileEncoding = "UTF-8")
      }
    )
  ),
  conditionalPanel(
    condition = "input.selectArquivo == 'XLSX'",
    downloadHandler(
      filename = reactive({
        case_when(
          input$selectNivel == "Nacional" ~ paste0(glue::glue("obitos_{nome_tabela()}_"), janitor::make_clean_names(input$selectNivel), input$selectAno, ".xlsx"),
          input$selectNivel == "Estadual" ~ paste0(glue::glue("obitos_{nome_tabela()}_"), janitor::make_clean_names(input$selectEstado), input$selectAno, ".xlsx"),
          input$selectNivel == "Municipal" ~
            paste0(glue::glue("obitos_{nome_tabela()}_"), janitor::make_clean_names(gsub(" ", "_", gsub(" - ", " ", input$selectMunicipio))), input$selectAno, ".xlsx")
        )
        }),
      content = function(file) {
        write.xlsx(dados_download(), file, sep = ";", row.names = FALSE, fileEncoding = "UTF-8")
      }
    )
  )
)


dados_filtrados <- reactive({
  if (input$selectNivel == "Municipal") {
    req(input$selectEstadoMuni)
  }
  if (input$selectNivel == "Nacional") {
    dados_obitos_fetais_neonatais |>
      filter(
        ano == input$selectAno,
        regiao %in% input$selectRegiao,
        faixa_de_peso %in% input$selectPeso,
        racacor %in% input$selectRaca
      ) |>
      filter(
        if (input$selectTipo == "Neonatais") 
          tipo_do_obito %in% c("Neonatais precoces", "Neonatais tardios")
        else 
          tipo_do_obito == input$selectTipo
      ) |>
      group_by(regiao, ano, capitulo_cid10, grupo_cid10, causabas_categoria, tipo_do_obito, faixa_de_peso, racacor) |>
      summarise(obitos = sum(as.numeric(obitos))) |>
      ungroup()
  } else if (input$selectNivel == "Estadual") {
    dados_obitos_fetais_neonatais |>
      filter(
        ano == input$selectAno,
        uf == unique(tabela_aux_municipios$sigla_uf[which(tabela_aux_municipios$uf == input$selectEstado)]),
        faixa_de_peso %in% input$selectPeso,
        racacor %in% input$selectRaca
      ) |>
      filter(
        if (input$selectTipo == "Neonatais") 
          tipo_do_obito %in% c("Neonatais precoces", "Neonatais tardios")
        else 
          tipo_do_obito == input$selectTipo
      ) |>
      group_by(uf, regiao, ano, capitulo_cid10, grupo_cid10, causabas_categoria, tipo_do_obito, faixa_de_peso, racacor) |>
      summarise(obitos = sum(as.numeric(obitos))) |>
      ungroup() 
  } else if (input$selectNivel == "Municipal") {
    dados_obitos_fetais_neonatais |>
      filter(
        ano == input$selectAno,
        uf == unique(tabela_aux_municipios$sigla_uf[which(tabela_aux_municipios$uf == input$selectEstadoMuni)]),
        municipio == input$selectMunicipio,
        faixa_de_peso %in% input$selectPeso,
        racacor %in% input$selectRaca
      ) |>
      filter(
        if (input$selectTipo == "Neonatais") 
          tipo_do_obito %in% c("Neonatais precoces", "Neonatais tardios")
        else 
          tipo_do_obito == input$selectTipo
      ) |>
      group_by(municipio, uf, regiao, ano, capitulo_cid10, grupo_cid10, causabas_categoria, tipo_do_obito, faixa_de_peso, racacor) |>
      summarise(obitos = sum(as.numeric(obitos))) |>
      ungroup()
  }
})

dados_download <- reactive({
  req(input$selectEstadoMuni)
  if (input$selectTipo == "Neonatais") {
    dados_filtrados() |>
      mutate(
        tipo_do_obito = "Neonatais"
      )
  } else {
    dados_filtrados()
  }
})

nome_tabela <- reactive({
    case_when(
    input$selectTipo == "Fetais" ~ "fetais",
    input$selectTipo == "Neonatais precoces" ~ "neonatais precoces",
    input$selectTipo == "Neonatais tardios" ~ "neonatais tardios",
    input$selectTipo == "Neonatais" ~ "neonatais",
    input$selectTipo == "Pós-neonatais" ~ "pós-neonatais"
  ) 
})

```

*****

Neste painel, um óbito foi considerado fetal caso tenha sido registrado no SIM-DOFET com idade gestacional igual ou superior a 22 semanas (`((GESTACAO != "Menos de 22 semanas" & !is.na(GESTACAO)) | (SEMAGESTAC >= 22 & SEMAGESTAC != 99))`) ou com peso igual ou superior a 500 g (`PESO >= 500`). O valor `99` da variável `SEMAGESTAC` foi considerado como um valor faltante.




Row 
-------------------------------------
   
### <span style = 'font-weight: 700; color: black'>Tabela de óbitos `r reactive(nome_tabela())` por categoria da CID-10</span>

```{r tabela_om}
dados_tabela <- reactive({
  if (input$selectNivel == "Nacional") {
    dados_filtrados() |>
      select(!c(ano, regiao, tipo_do_obito))
  } else if (input$selectNivel == "Estadual") {
    dados_filtrados() |>
      select(!c(uf, regiao, ano, tipo_do_obito))
  } else if (input$selectNivel == "Municipal") {
    dados_filtrados() |>
      select(!c(municipio, uf, regiao, ano, tipo_do_obito))
  }
})


renderReactable({
  validate(
    need(nrow(dados_tabela()) != 0, message = glue::glue("Não existem registros de óbitos {nome_tabela()} para os filtros selecionados."))
  )
  if (nrow(dados_tabela()) > 0) {
    dados_tabela() |>
      reactable(
        groupBy = c("capitulo_cid10", "grupo_cid10", "causabas_categoria", "faixa_de_peso"),
        columns = list(
          capitulo_cid10 = colDef(
            name = "Capítulo CID-10",
            footer = "Total"
          ),
          grupo_cid10 = colDef(
            name = "Grupo CID-10",
            aggregate = JS("function() { return ''}"),
            format = list(aggregated = colFormat(prefix = "Todos"))
          ),
          causabas_categoria = colDef(
            name = "Categoria CID-10",
            aggregate = JS("function() { return ''}"),
            format = list(aggregated = colFormat(prefix = "Todas"))
          ),
          faixa_de_peso = colDef(
            name = "Faixa de peso",
            aggregate = JS("function() { return ''}"),
            format = list(aggregated = colFormat(prefix = "Todas"))
          ),
          racacor = colDef(
            name = "Raça/cor",
            aggregate = JS("function() { return ''}"),
            format = list(aggregated = colFormat(prefix = "Todas"))
          ),
          obitos = colDef(
            name = "Nº de óbitos",
            aggregate = "sum",
            footer = JS(
              "function(colInfo) {
                let obitosTotais = 0
                colInfo.data.forEach(function(row) {
                  obitosTotais += row['obitos']
                })
                return obitosTotais
              }"
            )
          )
        ),
        defaultSorted = c("grupo_cid10", "capitulo_cid10", "causabas_categoria"),
        sortable = TRUE,
        resizable = TRUE,
        filterable = TRUE,
        highlight = TRUE,
        striped = TRUE,
        bordered = FALSE,
        pagination = FALSE,
        defaultColDef = colDef(footerStyle = list(fontWeight = "bold")),
        rowStyle = JS(
          "function(rowInfo) {
          if (rowInfo.aggregated === true) {
           return { fontWeight: 700 }
          }
        }"
        )
      )
  }
})


```   


Óbitos por causas principais {data-navmenu="Visualizações"}
=========================================================

Inputs {.sidebar data-width=350 style="width: 350px; visibility: visible; top: 75px;"}
------------------------------------- 
```{r input-principais}
hr();h5(span("Óbitos fetais e neonatais por causas principais", style = "font-weight: bold;")); hr()
p(em("Obs.: os dados de 2023 são preliminares."))
hr()

selectInput(
  inputId = "selectTipoP",
  label = HTML("<span class = 'negrito'> Selecione o tipo de óbito: </span>"),
  choices = c("Fetais", "Neonatais precoces", "Neonatais tardios", "Neonatais", "Pós-neonatais")
)

hr()
span("Temporalidade e localidade", style = "font-weight: bold; font-size: 17px")
HTML("<span style='display: block; margin-bottom: 7px;'> </span>")

numericInput(
  inputId = "selectAnoP",
  label = HTML("<span class = 'negrito'> Selecione o ano de análise (apenas para a tabela): </span>"),
  value = max(dados_obitos_fetais_neonatais$ano),
  min = min(dados_obitos_fetais_neonatais$ano),
  max = max(dados_obitos_fetais_neonatais$ano)
)

selectInput(
  inputId = "selectNivelP",
  label = HTML("<span class = 'negrito'> Selecione o nível de análise: </span>"),
  choices = c("Nacional", "Estadual", "Municipal"),
  selected = "Nacional"
)

conditionalPanel(
  condition = "input.selectNivelP == 'Nacional'",
  checkboxGroupInput(
    inputId = "selectRegiaoP",
    label = HTML("<span class = 'negrito'> Selecione as regiões de análise: </span>"),
    choices = c("Norte", "Nordeste", "Centro-Oeste", "Sudeste", "Sul"),
    selected = c("Norte", "Nordeste", "Centro-Oeste", "Sudeste", "Sul")
  )
)

conditionalPanel(
  condition = "input.selectNivelP == 'Estadual'",
  selectInput(
    inputId = "selectEstadoP",
    label = HTML("<span class = 'negrito'> Selecione o estado: </span>"),
    choices = estadosChoices,
    multiple = FALSE
    )
)

conditionalPanel(
    condition = "input.selectNivelP == 'Municipal'",
    selectizeInput(
      inputId = "selectEstadoMuniP",
      label = HTML("<span class = 'negrito'> Selecione o estado ao qual pertence o município: </span>"),
      choices = estadosChoices,
      options = list(placeholder = "Selecione um estado")
    ),
    selectizeInput(
      inputId = "selectMunicipioP",
      label = HTML("<span class = 'negrito'> Selecione o município: </span>"),
      choices = NULL,
      options = list(placeholder = "Selecione um município")
    )
)

observeEvent(input$selectEstadoMuniP, {
  updateSelectizeInput(
    inputId = "selectMunicipioP",
    choices = sort(dados_obitos_fetais_neonatais |> dplyr::filter(uf == unique(tabela_aux_municipios$sigla_uf[which(tabela_aux_municipios$uf == input$selectEstadoMuniP)])) |> pull(municipio) |> unique())
  )
})

hr()
span("Características do feto ou neonato", style = "font-weight: bold; font-size: 17px")
HTML("<span style='display: block; margin-bottom: 7px;'> </span>")


checkboxGroupInput(
  inputId = "selectPesoP",
  label = HTML("<span class = 'negrito'> Selecione as faixas de peso ao nascer: </span>"),
  choices = c("< 1500 g", "1500 a 1999 g", "2000 a 2499 g", "≥ 2500 g", "Sem informação"),
  selected = c("< 1500 g", "1500 a 1999 g", "2000 a 2499 g", "≥ 2500 g", "Sem informação")
)

checkboxGroupInput(
  inputId = "selectRacaP",
  label = HTML("<span class = 'negrito'> Selecione a raça/cor do feto ou neonato: </span>"),
  choices = c("Branca", "Preta", "Amarela", "Parda", "Indígena", "Ignorado"),
  selected = c("Branca", "Preta", "Amarela", "Parda", "Indígena", "Ignorado")
)

hr()

selectInput(
  inputId = "selectDownloadP",
  label = HTML("<span class = 'negrito'> Deseja fazer o download dessa tabela? </span>"),
  choices = c("Não", "Sim"),
  selected = "Não"
)

conditionalPanel(
  condition = "input.selectDownloadP == 'Sim'",
  selectInput(
    inputId = "selectArquivoP",
    label = HTML("<span class = 'negrito'> Selecione o tipo do arquivo: </span>"),
    choices = c("CSV", "XLSX"),
    selected = "CSV"
  ),
  conditionalPanel(
    condition = "input.selectArquivoP == 'CSV'",
    downloadHandler(
      filename = reactive({
        case_when(
          input$selectNivelP == "Nacional" ~ paste0(glue::glue("obitos_{nome_tabela()}_"), janitor::make_clean_names(input$selectNivelP), input$selectAnoP, ".csv"),
          input$selectNivelP == "Estadual" ~ paste0(glue::glue("obitos_{nome_tabela()}_"), janitor::make_clean_names(input$selectEstadoP), input$selectAnoP, ".csv"),
          input$selectNivelP == "Municipal" ~
            paste0(glue::glue("obitos_{nome_tabela()}_"), janitor::make_clean_names(gsub(" ", "_", gsub(" - ", " ", input$selectMunicipioP))), input$selectAnoP, ".csv")
        )
        }),
      content = function(file) {
        write.table(dados_download(), file, sep = ";", row.names = FALSE, fileEncoding = "UTF-8")
      }
    )
  ),
  conditionalPanel(
    condition = "input.selectArquivoP == 'XLSX'",
    downloadHandler(
      filename = reactive({
        case_when(
          input$selectNivelP == "Nacional" ~ paste0(glue::glue("obitos_{nome_tabela()}_"), janitor::make_clean_names(input$selectNivelP), input$selectAnoP, ".xlsx"),
          input$selectNivelP == "Estadual" ~ paste0(glue::glue("obitos_{nome_tabela()}_"), janitor::make_clean_names(input$selectEstadoP), input$selectAnoP, ".xlsx"),
          input$selectNivelP == "Municipal" ~
            paste0(glue::glue("obitos_{nome_tabela()}_"), janitor::make_clean_names(gsub(" ", "_", gsub(" - ", " ", input$selectMunicipioP))), input$selectAnoP, ".xlsx")
        )
        }),
      content = function(file) {
        write.xlsx(dados_download(), file, sep = ";", row.names = FALSE, fileEncoding = "UTF-8")
      }
    )
  )
)


dados_principais_filtrados <- reactive({
  if (input$selectNivelP == "Municipal") {
    req(input$selectEstadoMuniP)
  }
  if (input$selectNivelP == "Nacional") {
    dados_obitos_fetais_neonatais |>
      filter(
        ano == input$selectAnoP,
        regiao %in% input$selectRegiaoP,
        faixa_de_peso %in% input$selectPesoP,
        racacor %in% input$selectRacaP
      ) |>
      filter(
        if (input$selectTipoP == "Neonatais") 
          tipo_do_obito %in% c("Neonatais precoces", "Neonatais tardios")
        else 
          tipo_do_obito == input$selectTipoP
      ) |>
      group_by(regiao, ano, capitulo_cid10, grupo_principais, causabas_categoria, tipo_do_obito, faixa_de_peso, racacor) |>
      summarise(obitos = sum(as.numeric(obitos))) |>
      ungroup()
  } else if (input$selectNivelP == "Estadual") {
    dados_obitos_fetais_neonatais |>
      filter(
        ano == input$selectAnoP,
        uf == unique(tabela_aux_municipios$sigla_uf[which(tabela_aux_municipios$uf == input$selectEstadoP)]),
        faixa_de_peso %in% input$selectPesoP,
        racacor %in% input$selectRacaP
      ) |>
      filter(
        if (input$selectTipoP == "Neonatais") 
          tipo_do_obito %in% c("Neonatais precoces", "Neonatais tardios")
        else 
          tipo_do_obito == input$selectTipoP
      ) |>
      group_by(uf, regiao, ano, capitulo_cid10, grupo_principais, causabas_categoria, tipo_do_obito, faixa_de_peso, racacor) |>
      summarise(obitos = sum(as.numeric(obitos))) |>
      ungroup() 
  } else if (input$selectNivelP == "Municipal") {
    dados_obitos_fetais_neonatais |>
      filter(
        ano == input$selectAnoP,
        uf == unique(tabela_aux_municipios$sigla_uf[which(tabela_aux_municipios$uf == input$selectEstadoMuniP)]),
        municipio == input$selectMunicipioP,
        faixa_de_peso %in% input$selectPesoP,
        racacor %in% input$selectRacaP
      ) |>
      filter(
        if (input$selectTipoP == "Neonatais") 
          tipo_do_obito %in% c("Neonatais precoces", "Neonatais tardios")
        else 
          tipo_do_obito == input$selectTipoP
      ) |>
      group_by(municipio, uf, regiao, ano, capitulo_cid10, grupo_principais, causabas_categoria, tipo_do_obito, faixa_de_peso, racacor) |>
      summarise(obitos = sum(as.numeric(obitos))) |>
      ungroup()
  }
})

dados_download <- reactive({
  req(input$selectEstadoMuniP)
  if (input$selectTipoP == "Neonatais") {
    dados_principais_filtrados() |>
      mutate(
        tipo_do_obito = "Neonatais",
        grupo_principais = dplyr::case_when(
        grupo_principais == "principais_a00_b99" ~ "(A00-B99) Infecciosas",
        grupo_principais == "principais_j00_j99" ~ "(J00-J99) Respiratórias",
        grupo_principais == "principais_p00_p04" ~ "(P00-P04) Fatores maternos e condições da gravidez, parto e trabalho de parto",
        grupo_principais == "principais_p05_p08" ~ "(P05-P08) Duração da gestação e crescimento fetal",
        grupo_principais == "principais_p10_p15" ~ "(P10-P15) Traumatismo de parto",
        grupo_principais == "principais_p20_p29" ~ "(P20-P29) Transtornos respiratórios e cardiovasculares do período fetal",
        grupo_principais == "principais_p35_p39" ~ "(P35-P39) Infecções do período fetal",
        grupo_principais == "principais_p50_p61" ~ "(P50-P61) Transtornos hemorrágicos e hematológicos",
        grupo_principais == "principais_p70_p74" ~ "(P70-P74) Transtornos endócrinos e metabólicos transitórios",
        grupo_principais == "principais_p75_p78" ~ "(P75-P78) Transtornos do aparelho digestivo",
        grupo_principais == "principais_p80_p83" ~ "(P80-P83) Afecções comprometendo tegumento e regulação térmica ",
        grupo_principais == "principais_p90_p96" ~ "(P90-P96) Outros transtornos no período fetal",
        grupo_principais == "principais_a00_b99" ~ "(A00-B99) Infecciosas",
        grupo_principais == "principais_q00_q99" ~ "(Q00-Q99) Anomalias congênitas",
        grupo_principais == "principais_outros" ~ "Demais causas",
      )
    )
  } else {
    dados_principais_filtrados() |>
      mutate(
        grupo_principais = dplyr::case_when(
          grupo_principais == "principais_a00_b99" ~ "(A00-B99) Infecciosas",
          grupo_principais == "principais_j00_j99" ~ "(J00-J99) Respiratórias",
          grupo_principais == "principais_p00_p04" ~ "(P00-P04) Fatores maternos e condições da gravidez, parto e trabalho de parto",
          grupo_principais == "principais_p05_p08" ~ "(P05-P08) Duração da gestação e crescimento fetal",
          grupo_principais == "principais_p10_p15" ~ "(P10-P15) Traumatismo de parto",
          grupo_principais == "principais_p20_p29" ~ "(P20-P29) Transtornos respiratórios e cardiovasculares do período fetal",
          grupo_principais == "principais_p35_p39" ~ "(P35-P39) Infecções do período fetal",
          grupo_principais == "principais_p50_p61" ~ "(P50-P61) Transtornos hemorrágicos e hematológicos",
          grupo_principais == "principais_p70_p74" ~ "(P70-P74) Transtornos endócrinos e metabólicos transitórios",
          grupo_principais == "principais_p75_p78" ~ "(P75-P78) Transtornos do aparelho digestivo",
          grupo_principais == "principais_p80_p83" ~ "(P80-P83) Afecções comprometendo tegumento e regulação térmica ",
          grupo_principais == "principais_p90_p96" ~ "(P90-P96) Outros transtornos no período fetal",
          grupo_principais == "principais_a00_b99" ~ "(A00-B99) Infecciosas",
          grupo_principais == "principais_q00_q99" ~ "(Q00-Q99) Anomalias congênitas",
          grupo_principais == "principais_outros" ~ "Demais causas",
        )
      )
  }
})

nome_tabela <- reactive({
    case_when(
    input$selectTipoP == "Fetais" ~ "fetais",
    input$selectTipoP == "Neonatais precoces" ~ "neonatais precoces",
    input$selectTipoP == "Neonatais tardios" ~ "neonatais tardios",
    input$selectTipoP == "Neonatais" ~ "neonatais",
    input$selectTipoP == "Pós-neonatais" ~ "pós-neonatais"
  ) 
})

```

*****

Neste painel, um óbito foi considerado fetal caso tenha sido registrado no SIM-DOFET com idade gestacional igual ou superior a 22 semanas (`((GESTACAO != "Menos de 22 semanas" & !is.na(GESTACAO)) | (SEMAGESTAC >= 22 & SEMAGESTAC != 99))`) ou com peso igual ou superior a 500 g (`PESO >= 500`). O valor `99` da variável `SEMAGESTAC` foi considerado como um valor faltante.




Row {.tabset .tabset-fade} 
-------------------------------------

### Tabela   

##### <span style = 'font-weight: 700; color: black'>Tabela de óbitos `r reactive(nome_tabela())` por causas principais definidas pelo DATASUS (Fonte: <a href = http://www2.datasus.gov.br/cid10/V2008/WebHelp/p00_p96.htm target = _blank>DATASUS</a>)</span>

```{r tabela_p}
tags$style(HTML("
  .chart-wrapper .chart-stage {
    overflow: auto
  }
"))

dados_principais_tabela <- reactive({
  if (input$selectNivelP == "Nacional") {
    dados_principais_filtrados() |>
      select(!c(ano, regiao, tipo_do_obito)) 
  } else if (input$selectNivelP == "Estadual") {
    dados_principais_filtrados() |>
      select(!c(uf, regiao, ano, tipo_do_obito)) 
  } else if (input$selectNivelP == "Municipal") {
    dados_principais_filtrados() |>
      select(!c(municipio, uf, regiao, ano, tipo_do_obito)) 
  }
})


renderReactable({
  validate(
    need(nrow(dados_principais_tabela()) != 0, message = glue::glue("Não existem registros de óbitos {nome_tabela()} para os filtros selecionados."))
  )
  if (nrow(dados_principais_tabela()) > 0) {
    dados_principais_tabela() |>
        mutate(
          grupo_principais = dplyr::case_when(
            grupo_principais == "principais_a00_b99" ~ "(A00-B99) Infecciosas",
            grupo_principais == "principais_j00_j99" ~ "(J00-J99) Respiratórias",
            grupo_principais == "principais_p00_p04" ~ "(P00-P04) Fatores maternos e condições da gravidez, parto e trabalho de parto",
            grupo_principais == "principais_p05_p08" ~ "(P05-P08) Duração da gestação e crescimento fetal",
            grupo_principais == "principais_p10_p15" ~ "(P10-P15) Traumatismo de parto",
            grupo_principais == "principais_p20_p29" ~ "(P20-P29) Transtornos respiratórios e cardiovasculares do período fetal",
            grupo_principais == "principais_p35_p39" ~ "(P35-P39) Infecções do período fetal",
            grupo_principais == "principais_p50_p61" ~ "(P50-P61) Transtornos hemorrágicos e hematológicos",
            grupo_principais == "principais_p70_p74" ~ "(P70-P74) Transtornos endócrinos e metabólicos transitórios",
            grupo_principais == "principais_p75_p78" ~ "(P75-P78) Transtornos do aparelho digestivo",
            grupo_principais == "principais_p80_p83" ~ "(P80-P83) Afecções comprometendo tegumento e regulação térmica ",
            grupo_principais == "principais_p90_p96" ~ "(P90-P96) Outros transtornos no período fetal",
            grupo_principais == "principais_a00_b99" ~ "(A00-B99) Infecciosas",
            grupo_principais == "principais_q00_q99" ~ "(Q00-Q99) Anomalias congênitas",
            grupo_principais == "principais_outros" ~ "Demais causas",
          )
      ) |>
      reactable(
        groupBy = c("capitulo_cid10", "grupo_principais", "causabas_categoria", "faixa_de_peso"),
        columns = list(
          capitulo_cid10 = colDef(
            name = "Capítulo CID-10",
            footer = "Total"
          ),
          grupo_principais = colDef(
            name = "Grupo de causas principais",
            aggregate = JS("function() { return ''}"),
            format = list(aggregated = colFormat(prefix = "Todos"))
          ),
          causabas_categoria = colDef(
            name = "Categoria CID-10",
            aggregate = JS("function() { return ''}"),
            format = list(aggregated = colFormat(prefix = "Todas"))
          ),
          faixa_de_peso = colDef(
            name = "Faixa de peso",
            aggregate = JS("function() { return ''}"),
            format = list(aggregated = colFormat(prefix = "Todas"))
          ),
          racacor = colDef(
            name = "Raça/cor",
            aggregate = JS("function() { return ''}"),
            format = list(aggregated = colFormat(prefix = "Todas"))
          ),
          obitos = colDef(
            name = "Nº de óbitos",
            aggregate = "sum",
            footer = JS(
              "function(colInfo) {
                let obitosTotais = 0
                colInfo.data.forEach(function(row) {
                  obitosTotais += row['obitos']
                })
                return obitosTotais
              }"
            )
          )
        ),
        defaultSorted = c("capitulo_cid10", "grupo_principais", "causabas_categoria"),
        sortable = TRUE,
        resizable = TRUE,
        filterable = TRUE,
        highlight = TRUE,
        striped = TRUE,
        bordered = FALSE,
        pagination = FALSE,
        defaultColDef = colDef(footerStyle = list(fontWeight = "bold")),
        rowStyle = JS(
          "function(rowInfo) {
          if (rowInfo.aggregated === true) {
           return { fontWeight: 700 }
          }
        }"
        )
      )
  }
})

```

### Gráfico 

##### <span style = 'font-weight: 700; color: black'> Distribuição percentual dos óbitos `r reactive(nome_tabela())` por causas principais definidas pelo DATASUS (Fonte: <a href = http://www2.datasus.gov.br/cid10/V2008/WebHelp/p00_p96.htm target = _blank> DATASUS </a>)</span> 


```{r grafico_principais}
shinyWidgets::pickerInput(
  inputId = "selectCidsPrincipais",
  label = "Selecione os grupos de causas principais da CID-10:",
  options = list(placeholder = "Selecione os grupos de causas principais da CID-10", `actions-box` = TRUE, `deselect-all-text` = "Desselecionar todas", `select-all-text` = "Selecionar todas", `none-selected-text` = "Nenhuma opção selecionada"),
  choices = c(
    "(A00-B99) Infecciosas" = "principais_a00_b99",
    "(J00-J99) Respiratórias" = "principais_j00_j99",
    "(P00-P04) Feto e recém nascido afetado por fatores maternos e por condições da gravidez, do trabalho de parto e do parto" = "principais_p00_p04",
    "(P05-P08) Transtornos relacionados com a duração da gestação e com o crescimento fetal" = "principais_p05_p08",
    "(P10-P15) Traumatismo de parto" = "principais_p10_p15",
    "(P20-P29) Transtornos respiratórios e cardiovasculares específicos do período fetal" = "principais_p20_p29",
    "(P35-P39) Infeccções específicas do período fetal" = "principais_p35_p39",
    "(P50-P61) Transtornos hemorrágicos e hematológicos do feto e do recém-nascido" = "principais_p50_p61",
    "(P70-P74) Transtornos endócrinos e metabólicos transitórios específicos do feto e do recém-nascido" = "principais_p70_p74",
    "(P75-P78) Transtornos do aparelho digestivo do feto ou do recém-nascido" = "principais_p75_p78",
    "(P80-P83) Afecções comprometendo o tegumento e a regulação térmica do feto e do recém-nascido" = "principais_p80_p83",
    "(P90-P96) Outros transtornos originados do período fetal" = "principais_p90_p96",
    "(Q00-Q99) Anomalias congênitas" = "principais_q00_q99"
  ),
  selected = c(
    "principais_a00_b99",
    "principais_j00_j99",
    "principais_p00_p04",
    "principais_p05_p08",
    "principais_p10_p15",
    "principais_p20_p29",
    "principais_p35_p39",
    "principais_p50_p61",
    "principais_p70_p74",
    "principais_p75_p78",
    "principais_p80_p83",
    "principais_p90_p96",
    "principais_q00_q99"
  ),
  multiple = TRUE,
  width = "100%"
)
```


```{r grafico-principais}
data_plot_principais_aux <- reactive({
  if (input$selectNivelP == "Municipal") {
    req(input$selectEstadoMuniP)
  }
  if (input$selectNivelP == "Nacional") {
    dados_obitos_fetais_neonatais |>
      filter(
        regiao %in% input$selectRegiaoP,
        faixa_de_peso %in% input$selectPesoP,
        racacor %in% input$selectRacaP
      ) |>
      filter(
        if (input$selectTipoP == "Neonatais")
          tipo_do_obito %in% c("Neonatais precoces", "Neonatais tardios")
        else
          tipo_do_obito == input$selectTipoP
      ) |>
      group_by(regiao, ano, capitulo_cid10, grupo_principais, causabas_categoria, tipo_do_obito, faixa_de_peso, racacor) |>
      summarise(obitos = sum(as.numeric(obitos))) |>
      ungroup()
  } else if (input$selectNivelP == "Estadual") {
    dados_obitos_fetais_neonatais |>
      filter(
        uf == unique(tabela_aux_municipios$sigla_uf[which(tabela_aux_municipios$uf == input$selectEstadoP)]),
        faixa_de_peso %in% input$selectPesoP,
        racacor %in% input$selectRacaP
      ) |>
      filter(
        if (input$selectTipoP == "Neonatais")
          tipo_do_obito %in% c("Neonatais precoces", "Neonatais tardios")
        else
          tipo_do_obito == input$selectTipoP
      ) |>
      group_by(uf, regiao, ano, capitulo_cid10, grupo_principais, causabas_categoria, tipo_do_obito, faixa_de_peso, racacor) |>
      summarise(obitos = sum(as.numeric(obitos))) |>
      ungroup()
  } else if (input$selectNivelP == "Municipal") {
    dados_obitos_fetais_neonatais |>
      filter(
        uf == unique(tabela_aux_municipios$sigla_uf[which(tabela_aux_municipios$uf == input$selectEstadoMuniP)]),
        municipio == input$selectMunicipioP,
        faixa_de_peso %in% input$selectPesoP,
        racacor %in% input$selectRacaP
      ) |>
      filter(
        if (input$selectTipoP == "Neonatais")
          tipo_do_obito %in% c("Neonatais precoces", "Neonatais tardios")
        else
          tipo_do_obito == input$selectTipoP
      ) |>
      group_by(municipio, uf, regiao, ano, capitulo_cid10, grupo_principais, causabas_categoria, tipo_do_obito, faixa_de_peso, racacor) |>
      summarise(obitos = sum(as.numeric(obitos))) |>
      ungroup()
  }
})

data_plot_principais_local <- reactive({
  data_plot_principais_aux() |>
    group_by(ano, grupo_principais) |>
    summarise(obitos = sum(obitos)) |>
    ungroup() |>
    pivot_wider(
      names_from = grupo_principais, values_from = obitos, values_fill = 0
    ) |>
    rowwise() |>
    mutate(obitos_totais = sum(dplyr::c_across(dplyr::starts_with("principais")))) |>
    dplyr::mutate_at(dplyr::vars(dplyr::starts_with("principais")), ~ (. / obitos_totais * 100)) |>
    tidyr::pivot_longer(
      cols = dplyr::contains("principais"),
      names_to = "grupo_principais",
      values_to = "porc_obitos"
    ) |>
    mutate(
      grupo_principais = ifelse(
        grupo_principais %in% input$selectCidsPrincipais,
        dplyr::case_when(
          grupo_principais == "principais_a00_b99" ~ "(A00-B99) Infecciosas",
          grupo_principais == "principais_j00_j99" ~ "(J00-J99) Respiratórias",
          grupo_principais == "principais_p00_p04" ~ "(P00-P04) Fatores maternos e condições da gravidez, parto e trabalho de parto",
          grupo_principais == "principais_p05_p08" ~ "(P05-P08) Duração da gestação e crescimento fetal",
          grupo_principais == "principais_p10_p15" ~ "(P10-P15) Traumatismo de parto",
          grupo_principais == "principais_p20_p29" ~ "(P20-P29) Transtornos respiratórios e cardiovasculares do período fetal",
          grupo_principais == "principais_p35_p39" ~ "(P35-P39) Infecções do período fetal",
          grupo_principais == "principais_p50_p61" ~ "(P50-P61) Transtornos hemorrágicos e hematológicos",
          grupo_principais == "principais_p70_p74" ~ "(P70-P74) Transtornos endócrinos e metabólicos transitórios",
          grupo_principais == "principais_p75_p78" ~ "(P75-P78) Transtornos do aparelho digestivo",
          grupo_principais == "principais_p80_p83" ~ "(P80-P83) Afecções comprometendo tegumento e regulação térmica ",
          grupo_principais == "principais_p90_p96" ~ "(P90-P96) Outros transtornos no período fetal",
          grupo_principais == "principais_a00_b99" ~ "(A00-B99) Infecciosas",
          grupo_principais == "principais_q00_q99" ~ "(Q00-Q99) Anomalias congênitas",
          grupo_principais == "principais_outros" ~ "Demais causas",
        ),
        "Demais causas"
      )
    ) |>
    group_by(ano, grupo_principais) |>
    summarise(porc_obitos = round(sum(porc_obitos), 1)) |>
    ungroup()
})


data_plot_principais_referencia <- reactive({
  dados_obitos_fetais_neonatais |>
    filter(
      faixa_de_peso %in% input$selectPesoP,
        racacor %in% input$selectRacaP
    ) |>
    filter(
      if (input$selectTipoP == "Neonatais")
        tipo_do_obito %in% c("Neonatais precoces", "Neonatais tardios")
      else
        tipo_do_obito == input$selectTipoP
    ) |>
    group_by(ano, grupo_principais) |>
    summarise(obitos = sum(as.numeric(obitos))) |>
    ungroup() |>
    pivot_wider(
    names_from = grupo_principais, values_from = obitos, values_fill = 0
  ) |>
  rowwise() |>
  mutate(obitos_totais = sum(dplyr::c_across(dplyr::starts_with("principais")))) |>
  dplyr::mutate_at(dplyr::vars(dplyr::starts_with("principais")), ~ (. / obitos_totais * 100)) |>
  tidyr::pivot_longer(
    cols = dplyr::contains("principais"),
    names_to = "grupo_principais",
    values_to = "br_porc_obitos"
  ) |>
  mutate(
    grupo_principais = ifelse(
      grupo_principais %in% input$selectCidsPrincipais,
      dplyr::case_when(
        grupo_principais == "principais_a00_b99" ~ "(A00-B99) Infecciosas",
        grupo_principais == "principais_j00_j99" ~ "(J00-J99) Respiratórias",
        grupo_principais == "principais_p00_p04" ~ "(P00-P04) Fatores maternos e condições da gravidez, parto e trabalho de parto",
        grupo_principais == "principais_p05_p08" ~ "(P05-P08) Duração da gestação e crescimento fetal",
        grupo_principais == "principais_p10_p15" ~ "(P10-P15) Traumatismo de parto",
        grupo_principais == "principais_p20_p29" ~ "(P20-P29) Transtornos respiratórios e cardiovasculares do período fetal",
        grupo_principais == "principais_p35_p39" ~ "(P35-P39) Infecções do período fetal",
        grupo_principais == "principais_p50_p61" ~ "(P50-P61) Transtornos hemorrágicos e hematológicos",
        grupo_principais == "principais_p70_p74" ~ "(P70-P74) Transtornos endócrinos e metabólicos transitórios",
        grupo_principais == "principais_p75_p78" ~ "(P75-P78) Transtornos do aparelho digestivo",
        grupo_principais == "principais_p80_p83" ~ "(P80-P83) Afecções comprometendo tegumento e regulação térmica ",
        grupo_principais == "principais_p90_p96" ~ "(P90-P96) Outros transtornos no período fetal",
        grupo_principais == "principais_a00_b99" ~ "(A00-B99) Infecciosas",
        grupo_principais == "principais_q00_q99" ~ "(Q00-Q99) Anomalias congênitas",
        grupo_principais == "principais_outros" ~ "Demais causas",
      ),
      "Demais causas"
    )
  ) |>
  group_by(ano, grupo_principais) |>
  summarise(br_porc_obitos = round(sum(br_porc_obitos), 1)) |>
  ungroup()
})

data_plot_principais <- reactive(full_join(data_plot_principais_local(), data_plot_principais_referencia()))


highcharter::renderHighchart({
  highcharter::highchart() |>
    highcharter::hc_add_series(
      data = data_plot_principais(),
      highcharter::hcaes(x = ano, y = porc_obitos, group = grupo_principais),
      type = "column",
      showInLegend = TRUE,
      tooltip = list(
        pointFormat = "<span style = 'color: {series.color}'> &#9679 </span> {series.name}: <b> {point.y}% </b> <br> Média nacional: <b> {point.br_porc_obitos:,f}% </b>"
      )
    ) |>
    highcharter::hc_plotOptions(series = list(stacking = "percent")) |>
    highcharter::hc_legend(reversed = FALSE, title = list(text = "Grupo CID-10")) |>
    highcharter::hc_colors(
      viridis::magma(length(unique(data_plot_principais()$grupo_principais)) + 2, direction = 1)[-c(1, length(unique(data_plot_principais()$grupo_principais)) + 2)]
    ) |>
    highcharter::hc_xAxis(title = list(text = ""), categories = unique(data_plot_principais()$ano), allowDecimals = FALSE) |>
    highcharter::hc_yAxis(title = list(text = glue::glue("% relativo ao total de óbitos {nome_tabela()} por causas principais")), min = 0, max = 100)

})
```

